

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon1.png">
  <link rel="icon" href="/img/favicon1.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Peter Pan">
  <meta name="keywords" content="">
  
    <meta name="description" content="Java集合Collection体系  Map体系  JVM内存结构 堆（heap）： 栈（stack）： 程序计数器（pc register)：记录程序执行到哪里 方法区：运行时常量池，类信息。  方法区是jvm抽象的规范。 永久代（permgen）是堆空间的一部分 1.8以后  元空间（metaspcae）独立出来空间，使用的本地内存，理论上系统内存有多大元空间就多大。 本地方法栈（nativ">
<meta property="og:type" content="article">
<meta property="og:title" content="INTERVIEW">
<meta property="og:url" content="http://example.com/2022/11/17/INTERVIEW/index.html">
<meta property="og:site_name" content="PPStudy">
<meta property="og:description" content="Java集合Collection体系  Map体系  JVM内存结构 堆（heap）： 栈（stack）： 程序计数器（pc register)：记录程序执行到哪里 方法区：运行时常量池，类信息。  方法区是jvm抽象的规范。 永久代（permgen）是堆空间的一部分 1.8以后  元空间（metaspcae）独立出来空间，使用的本地内存，理论上系统内存有多大元空间就多大。 本地方法栈（nativ">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://github.com/gorhaf/2021-Java-Collection-Tutorial/blob/main/part01/Collection%E4%BD%93%E7%B3%BB.jpeg?raw=true">
<meta property="og:image" content="https://github.com/gorhaf/2021-Java-Collection-Tutorial/blob/main/part01/Map%E4%BD%93%E7%B3%BB.jpeg?raw=true">
<meta property="og:image" content="http://example.com/Users/peterpan/Library/Application%20Support/typora-user-images/Screen%20Shot%202022-11-22%20at%2010.25.43.png">
<meta property="og:image" content="http://example.com/Users/peterpan/Library/Application%20Support/typora-user-images/Screen%20Shot%202022-11-22%20at%2010.20.52.png">
<meta property="og:image" content="https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/java/jvm/java-runtime-data-areas-jdk1.8.png">
<meta property="og:image" content="http://example.com/Users/peterpan/Library/Application%20Support/typora-user-images/Screen%20Shot%202022-11-23%20at%2010.42.21.png">
<meta property="og:image" content="http://example.com/Users/peterpan/Library/Application%20Support/typora-user-images/Screen%20Shot%202022-11-23%20at%2010.46.01.png">
<meta property="og:image" content="http://example.com/Users/peterpan/Library/Application%20Support/typora-user-images/Screen%20Shot%202022-11-23%20at%2010.54.38.png">
<meta property="og:image" content="https://cdn.jsdeliver.net/gh/PanyuHaa/PicGo/img/Screen%20Shot%202022-11-17%20at%2018.21.29.png">
<meta property="og:image" content="http://example.com/Users/peterpan/Library/Application%20Support/typora-user-images/Screen%20Shot%202022-11-18%20at%2019.48.37.png">
<meta property="og:image" content="http://example.com/Users/peterpan/Library/Application%20Support/typora-user-images/Screen%20Shot%202022-11-18%20at%2020.05.31.png">
<meta property="og:image" content="http://example.com/Users/peterpan/Library/Application%20Support/typora-user-images/Screen%20Shot%202022-11-18%20at%2020.20.25.png">
<meta property="og:image" content="http://example.com/Users/peterpan/Desktop/Screen%20Shot%202022-11-18%20at%2020.21.36.png">
<meta property="og:image" content="http://example.com/Users/peterpan/Library/Application%20Support/typora-user-images/Screen%20Shot%202022-11-18%20at%2020.27.21.png">
<meta property="og:image" content="http://example.com/Users/peterpan/Library/Application%20Support/typora-user-images/Screen%20Shot%202022-11-19%20at%2012.06.52.png">
<meta property="og:image" content="http://example.com/Users/peterpan/Library/Application%20Support/typora-user-images/Screen%20Shot%202022-11-21%20at%2009.52.25.png">
<meta property="og:image" content="http://example.com/Users/peterpan/Library/Application%20Support/typora-user-images/Screen%20Shot%202022-11-21%20at%2009.53.46.png">
<meta property="og:image" content="http://example.com/Users/peterpan/Library/Application%20Support/typora-user-images/Screen%20Shot%202022-11-21%20at%2009.54.41.png">
<meta property="og:image" content="http://example.com/Users/peterpan/Library/Application%20Support/typora-user-images/Screen%20Shot%202022-11-21%20at%2009.55.31.png">
<meta property="og:image" content="http://example.com/Users/peterpan/Library/Application%20Support/typora-user-images/Screen%20Shot%202022-11-21%20at%2010.00.27.png">
<meta property="og:image" content="http://example.com/Users/peterpan/Library/Application%20Support/typora-user-images/Screen%20Shot%202022-11-23%20at%2010.26.02.png">
<meta property="og:image" content="http://example.com/Users/peterpan/Library/Application%20Support/typora-user-images/Screen%20Shot%202022-11-19%20at%2016.05.43.png">
<meta property="og:image" content="http://example.com/Users/peterpan/Library/Application%20Support/typora-user-images/image-20221119162231298.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/738439/1663979614062-f3219a07-0815-4b0d-9b63-750219d9e59c.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/738439/1663979628031-1ccb8eb9-5da0-46d5-a16a-01f6724c2ee1.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/738439/1663979639394-8eb65a8f-5905-473d-90d8-47cba7c58ae5.png">
<meta property="og:image" content="https://www.yuque.com/api/filetransfer/images?url=https%3A%2F%2Fguide-blog-images.oss-cn-shenzhen.aliyuncs.com%2Fgithub%2Fjavaguide%2Fdatabase%2Fredis%2Fredis-cluster%2Fredis-cluster-shard.png&amp;sign=33a67ec08ad62aa857bafa46a651b091322094cb5ebd49722d3e45d87d76a619">
<meta property="og:image" content="https://raw.githubusercontent.com/csunny/etcd-from-arch-to-souce-code/master/_asserts/images/cap.jpg">
<meta property="og:image" content="http://example.com/Users/peterpan/Library/Application%20Support/typora-user-images/Screen%20Shot%202022-11-20%20at%2010.34.25.png">
<meta property="og:image" content="http://example.com/Users/peterpan/Library/Application%20Support/typora-user-images/Screen%20Shot%202022-11-20%20at%2010.34.51.png">
<meta property="article:published_time" content="2022-11-17T02:21:22.000Z">
<meta property="article:modified_time" content="2022-11-24T02:49:04.079Z">
<meta property="article:author" content="Peter Pan">
<meta property="article:tag" content="Back-End Engineer">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://github.com/gorhaf/2021-Java-Collection-Tutorial/blob/main/part01/Collection%E4%BD%93%E7%B3%BB.jpeg?raw=true">
  
  
  <title>INTERVIEW - PPStudy</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.14","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 6.1.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/banner2.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="INTERVIEW">
              
                INTERVIEW
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-11-17 10:21" pubdate>
        November 17, 2022 am
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      9k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      76 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">INTERVIEW</h1>
            
            <div class="markdown-body">
              <h1 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h1><h2 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h2><p><strong>Collection体系</strong></p>
<p><img src="https://github.com/gorhaf/2021-Java-Collection-Tutorial/blob/main/part01/Collection%E4%BD%93%E7%B3%BB.jpeg?raw=true" srcset="/img/loading.gif" lazyload alt="Collection体系.jpeg"></p>
<p><strong>Map体系</strong></p>
<p><img src="https://github.com/gorhaf/2021-Java-Collection-Tutorial/blob/main/part01/Map%E4%BD%93%E7%B3%BB.jpeg?raw=true" srcset="/img/loading.gif" lazyload alt="Map体系.jpeg"></p>
<h1 id="JVM"><a href="#JVM" class="headerlink" title="JVM"></a>JVM</h1><h2 id="内存结构"><a href="#内存结构" class="headerlink" title="内存结构"></a>内存结构</h2><p><img src="/Users/peterpan/Library/Application Support/typora-user-images/Screen Shot 2022-11-22 at 10.25.43.png" srcset="/img/loading.gif" lazyload alt="jvm"></p>
<p><strong>堆（heap）</strong>：</p>
<p><strong>栈（stack）</strong>：</p>
<p><strong>程序计数器（pc register)</strong>：记录程序执行到哪里</p>
<p><strong>方法区</strong>：运行时常量池，类信息。</p>
<p><img src="/Users/peterpan/Library/Application Support/typora-user-images/Screen Shot 2022-11-22 at 10.20.52.png" srcset="/img/loading.gif" lazyload alt="方法区"></p>
<p>方法区是jvm抽象的规范。</p>
<p>永久代（permgen）是堆空间的一部分</p>
<p><strong>1.8以后</strong></p>
<p><img src="https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/java/jvm/java-runtime-data-areas-jdk1.8.png" srcset="/img/loading.gif" lazyload alt="Java 运行时数据区域（JDK1.8 之后）"></p>
<p>元空间（metaspcae）独立出来空间，使用的本地内存，理论上系统内存有多大元空间就多大。</p>
<p><strong>本地方法栈（native method stack）</strong>：本地方法，其他语言编写的，java运行的。native关键字标记的，比如<code>thread.sleep()</code>。</p>
<h2 id="Java中jvm虚拟机栈"><a href="#Java中jvm虚拟机栈" class="headerlink" title="Java中jvm虚拟机栈"></a>Java中jvm虚拟机栈</h2><p>jvm内存结构</p>
<p><img src="/Users/peterpan/Library/Application Support/typora-user-images/Screen Shot 2022-11-23 at 10.42.21.png" srcset="/img/loading.gif" lazyload alt="jvm虚拟机栈"></p>
<p>虚拟机栈</p>
<p><img src="/Users/peterpan/Library/Application Support/typora-user-images/Screen Shot 2022-11-23 at 10.46.01.png" srcset="/img/loading.gif" lazyload alt="栈"></p>
<p>对象方法之间的调用通过栈，这样弹出栈顶（也就是gc不要的对象），所以jvm以方法作为最基本的执行单位，一个方法对应一个栈帧。</p>
<p><img src="/Users/peterpan/Library/Application Support/typora-user-images/Screen Shot 2022-11-23 at 10.54.38.png" srcset="/img/loading.gif" lazyload alt="对应解释"></p>
<p>具体看视频例子<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1ET4y1Z711/?spm_id_from=333.999.0.0&amp;vd_source=77c4f2aaa0a307827d6898104835a353">https://www.bilibili.com/video/BV1ET4y1Z711/?spm_id_from=333.999.0.0&amp;vd_source=77c4f2aaa0a307827d6898104835a353</a></p>
<h1 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h1><h2 id="原理-结构"><a href="#原理-结构" class="headerlink" title="原理+结构"></a>原理+结构</h2><h3 id="MySql的系统框架"><a href="#MySql的系统框架" class="headerlink" title="MySql的系统框架"></a>MySql的系统框架</h3><h4 id="连接池"><a href="#连接池" class="headerlink" title="连接池"></a>连接池</h4><p>起初：通过对接模块和连接驱动进行连接，然后频繁的断开和连接相当于网络的疯狂IO，非常浪费资源。</p>
<p>后来：连接池的出现解决了这个问题，可以设置最大连接数量，单词最大数据报文。</p>
<h4 id="SQL解析-优化"><a href="#SQL解析-优化" class="headerlink" title="SQL解析/优化"></a>SQL解析/优化</h4><p>SQL接口：接受sql文件。</p>
<p>SQL解析器：解析sql语句。</p>
<p>SQL优化器：调整sql语句执行顺序，配合索引等进行优化。</p>
<h4 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h4><p>MyISAM或者InnoDB，sql5.7版本以后开始默认为InnoDB。</p>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><p>安全、恢复、集群、缓存</p>
<h3 id="MySql数据写入原理"><a href="#MySql数据写入原理" class="headerlink" title="MySql数据写入原理"></a>MySql数据写入原理</h3><p>InnoDB引擎简介：事务控制、读写效率、多用户并发、索引搜索等众方面均很优秀。</p>
<p>通过内部的执行器对内存和磁盘中的数据进行写入或读取。</p>
<p>1、sql语句优化，将优化后的执行计划传送给存储引擎</p>
<p>2、执行器按照命令执行。内存的IO速度远大于磁盘，所以操作都在内存中执行，这个内存缓存区叫buffer pool。（为了方便回滚，将这些指令记录到Undo Log中。）</p>
<p>写入分为两部分：提高写入速度（buffer pool），保证写入可靠性（redo log）</p>
<p>总结：主要涉及到四大部分：执行器 <strong>—&gt;</strong> 内存（Buffer Pool，IO 线程， Redo Log Buffer） <strong>—&gt;</strong> 操作系统 &amp; 指令 <strong>—&gt;</strong> 磁盘（磁盘文件.ibd，Redo Log，Undo Log）</p>
<h4 id="Buffer-Pool"><a href="#Buffer-Pool" class="headerlink" title="Buffer Pool"></a>Buffer Pool</h4><p>作为一个数据的缓冲区提高读写效率，然后再用另外一个IO线程统一写入磁盘文件，以.ibd为结尾。</p>
<h4 id="Redo-Log"><a href="#Redo-Log" class="headerlink" title="Redo Log"></a>Redo Log</h4><p>会将“更新写入信息”放入内存中的另一个区域<strong>Redo Log Buffer</strong>，在进行刷盘，刷盘策略有三种。这个Redo Log Buffer就是用户态内存？然后所以需要先写入到系统内存中再操作磁盘文件。</p>
<ul>
<li><strong>0</strong> ：设置为 0 的时候，表示每次事务<strong>提交时不进行</strong>刷盘操作</li>
</ul>
<p>​                为<code>0</code>时，如果<code>MySQL</code>挂了或宕机可能会有<code>1</code>秒数据的丢失。（事务没有提交，但因为后台刷新还是会刷出来redo log，出现数据不一致）</p>
<p>​                （依靠后台线程刷盘）</p>
<ul>
<li><strong>1</strong> ：设置为 1 的时候，表示每次事务<strong>提交时都将进行</strong>刷盘操作（<strong>默认值</strong>）</li>
</ul>
<p>​                为<code>1</code>时， 只要事务提交成功，<code>redo log</code>记录就一定在硬盘里，不会有任何数据丢失。</p>
<p>​                如果事务执行期间<code>MySQL</code>挂了或宕机，这部分<strong>日志丢了，但是事务并没有提交</strong>，所以日志丢了也不会有损失。</p>
<p>​                （事务执行就直接刷盘，没执行完成就不刷盘，只能解决运行时出现的问题）</p>
<ul>
<li><strong>2</strong> ：设置为 2 的时候，表示每次事务<strong>提交时都只把 redo log buffer 内容写入 page cache</strong></li>
</ul>
<p>​                为<code>2</code>时， 只要事务提交成功，<code>redo log buffer</code>中的内容只写入文件系统缓存（<code>page cache</code>）。</p>
<p>​                如果仅仅只是<code>MySQL</code>挂了不会有任何数据丢失，但是宕机可能会有<code>1</code>秒数据的丢失。</p>
<p>​                （不主动刷盘，只记录在了文件系统缓冲中，所以不宕机就还能继续又后台线程刷盘写入）</p>
<p>整体分为，提交事务后做动作（1和2），和不提交事务也提交。1和2的区别是策略2是提交的时候先放入buffer中，这样降低了数据的损失为1s，降低了提交事务后的数据的丢失。而1不能够解决事务提交之后的数据损失，只能解决事务运行时的。</p>
<h4 id="Bin-Log"><a href="#Bin-Log" class="headerlink" title="Bin Log"></a>Bin Log</h4><p><img src="https://cdn.jsdeliver.net/gh/PanyuHaa/PicGo/img/Screen%20Shot%202022-11-17%20at%2018.21.29.png" srcset="/img/loading.gif" lazyload alt="执行原理"></p>
<p><code>redo log</code>（重做日志）让<code>InnoDB</code>存储引擎拥有了<strong>崩溃恢复</strong>能力。</p>
<p><code>binlog</code>（归档日志）保证了<code>MySQL</code>集群架构的数据<strong>一致性</strong>。</p>
<p>虽然它们都属于持久化的保证，但是侧重点不同。</p>
<p>在执行更新语句过程，会记录<code>redo log</code>与<code>binlog</code>两块日志，以<strong>基本的事务为单位</strong>，<code>redo log</code>在事务执行过程中可以不断写入，而<code>binlog</code>只有在提交事务时才写入，所以<code>redo log</code>与<code>binlog</code>的写入时机不一样。</p>
<h3 id="MySql的存储结构"><a href="#MySql的存储结构" class="headerlink" title="MySql的存储结构"></a>MySql的存储结构</h3><p>主要在磁盘和内存中，使用内存的原因是为了提升读写速度。</p>
<p>创建文件，t.frm 存储表结构等信息，t.ibd 表空间（存储数据和索引），5.7以后才生成独立表空间。独立表空间可以传输和压缩。</p>
<p><strong>页</strong>，InnoDB中内存和磁盘交互的最小存储单元。页内部的地址是连续的，因为通常要查的数据都会连续存在（固定大小16KB，与B+树的索引对应）。页是核心存储结构，其他的都是在他的基础上进行划分。</p>
<p><strong>行</strong>，记录数据行的具体数据，最大8KB。</p>
<p>这个特别像是操作系统中的段页式结构。</p>
<p>跨页读取，可能会遇到跨磁道读取，造成磁头移动，这个速度相当慢。</p>
<p><strong>区</strong>，为1M = 64 * 16KB = 1024KB，弄一个区来存64个页避免磁头移动，降低io速度。</p>
<p>避免浪费空间，新创建表的时候只会创建6个页，16*6 共 96KB，8.0版本后会创建7个页，零散的页会放在表空间中一个叫碎片区的地方，前四个分别记录了表空间和区组条目信息，Change buffer相关信息，段信息，索引根信息，后两个页为空闲页（可用页）。经典到容量一半的时候进行扩容，增加一个完整的区。</p>
<p><strong>组</strong>，管理256个区，即256M，区中的前四个信息页都是记录基础信息。</p>
<p><strong>段</strong>，逻辑分区，区分不同功能的区和在碎片区中的页，就是段页式存储的那个段，叶子结点段（存储和管理实际数据），非叶子结点段（存储和管理索引树）。非叶子结点段+叶子结点段组成独立表空间，即t.ibd</p>
<h3 id="MySql的执行原理"><a href="#MySql的执行原理" class="headerlink" title="MySql的执行原理"></a>MySql的执行原理</h3><h4 id="发出请求"><a href="#发出请求" class="headerlink" title="发出请求"></a>发出请求</h4><p>连接驱动（ORM）和连接池之间是半双工的。查询语句如果超过了mysql连接池设定的数据包上限，那么就会拒绝接受。</p>
<h4 id="查询缓存"><a href="#查询缓存" class="headerlink" title="查询缓存"></a>查询缓存</h4><p>Map结构，key是sql语句，value是查询结果。5.7版本默认关闭，8.0版本直接删除了。每次都要先查询一下缓存，命中率低的话就会占用很多空间，还有速度慢，反而效率降低。</p>
<h4 id="SQL解析器"><a href="#SQL解析器" class="headerlink" title="SQL解析器"></a>SQL解析器</h4><p>词法分析 sql/sql_lex.cc。拆分成关键字和非关键字。</p>
<p>bison语法分析器 sql/sql_yacc.cc。sql就被解析成一颗语法树。</p>
<h4 id="预处理器"><a href="#预处理器" class="headerlink" title="预处理器"></a>预处理器</h4><p>提交SQL模版语句，提交参数进行执行。这样可以复用模版，一种多路复用的思想。</p>
<h4 id="SQL优化器"><a href="#SQL优化器" class="headerlink" title="SQL优化器"></a>SQL优化器</h4><p>CBO，运用成本最低的方式执行sql语句。成本指的是体内的数据表、数据量、索引等等信息算出来SQL语句对应的IO成本消耗值和CPU成本消耗值。</p>
<p>有个优化轨迹的工具Optimizer_trace，展示任意一条语句的优化，记得关闭。</p>
<h4 id="执行器"><a href="#执行器" class="headerlink" title="执行器"></a>执行器</h4><p>执行器为每一个表创建一个Handler实例。优化器根据实例来获取表的信息。将执行计划送给存储引擎，然后返回结果</p>
<p><img src="/Users/peterpan/Library/Application Support/typora-user-images/Screen Shot 2022-11-18 at 19.48.37.png" srcset="/img/loading.gif" lazyload alt="Screen Shot 2022-11-18 at 19.48.37"></p>
<h3 id="MySql的运行原理"><a href="#MySql的运行原理" class="headerlink" title="MySql的运行原理"></a>MySql的运行原理</h3><h4 id="存储引擎InnoDB"><a href="#存储引擎InnoDB" class="headerlink" title="存储引擎InnoDB"></a>存储引擎InnoDB</h4><p><img src="/Users/peterpan/Library/Application Support/typora-user-images/Screen Shot 2022-11-18 at 20.05.31.png" srcset="/img/loading.gif" lazyload alt="mysql运行原理"></p>
<h3 id="Mysql“页”结构解析"><a href="#Mysql“页”结构解析" class="headerlink" title="Mysql“页”结构解析"></a>Mysql“页”结构解析</h3><p>数据页（索引页）</p>
<h4 id="页头、页尾"><a href="#页头、页尾" class="headerlink" title="页头、页尾"></a>页头、页尾</h4><p><strong>页头</strong>（校验和、页号、上页页号、下页页号、页类型、表空间ID，【最近一次修改的LSN，已被刷到磁盘的LSN，（日志序列号）】），里面包含了页之间关系，页自己的属性，还有具体存储的逻辑表空间的ID。</p>
<p>ps：日志序号(LSN) <strong>表示从数据库日志文件开头开始计算的日志记录的位移（以字节计）</strong>。</p>
<p><strong>页尾</strong>（校验和、最近一次修改的LSN）</p>
<p>crc32作为校验和来拯救一些没有写入完成的数据。</p>
<p>页头和页尾巴分别占用38字节和8字节，总计46字节。</p>
<p>数据行与真实的表数据一行行对应。</p>
<p><img src="/Users/peterpan/Library/Application Support/typora-user-images/Screen Shot 2022-11-18 at 20.20.25.png" srcset="/img/loading.gif" lazyload alt="数据行"></p>
<p><img src="/Users/peterpan/Desktop/Screen Shot 2022-11-18 at 20.21.36.png" srcset="/img/loading.gif" lazyload alt="Screen Shot 2022-11-18 at 20.21.36"></p>
<p>最小行和最大行用来制作一个可控的循环链表。</p>
<p>数据区分为用户区和空闲区。</p>
<h4 id="页目录"><a href="#页目录" class="headerlink" title="页目录"></a>页目录</h4><p>这部分建议看原视频。<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1pG4y1o7n3/?spm_id_from=333.788&amp;vd_source=77c4f2aaa0a307827d6898104835a353">https://www.bilibili.com/video/BV1pG4y1o7n3/?spm_id_from=333.788&amp;vd_source=77c4f2aaa0a307827d6898104835a353</a></p>
<h4 id="数据页头"><a href="#数据页头" class="headerlink" title="数据页头"></a>数据页头</h4><p>用来记录该页的所有基础信息，实时统计。</p>
<p><img src="/Users/peterpan/Library/Application Support/typora-user-images/Screen Shot 2022-11-18 at 20.27.21.png" srcset="/img/loading.gif" lazyload alt="数据页头"></p>
<h3 id="Mysql-行结构"><a href="#Mysql-行结构" class="headerlink" title="Mysql 行结构"></a>Mysql 行结构</h3><p>行数据dynamic类型，分为额外信息和真实数据。</p>
<p>null值列表用8位为单位去统计对应行列的信息，看起来是倒置的因为低位在右侧。</p>
<p><img src="/Users/peterpan/Library/Application Support/typora-user-images/Screen Shot 2022-11-19 at 12.06.52.png" srcset="/img/loading.gif" lazyload alt="dynamic数据行"> </p>
<p>剩下的看原视频</p>
<h3 id="MySql-为什么要有索引"><a href="#MySql-为什么要有索引" class="headerlink" title="MySql 为什么要有索引"></a>MySql 为什么要有索引</h3><h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><p>首先我们采用红黑树（一种自适应平衡二叉树）来构造索引，那么我们索引值就很容易了，从原来的4000次变成了log2（4000）= 11次的IO操作。二分查找的时间复杂度就是log2^(N)。</p>
<p>为了减少IO操作所造成的磁头转换让资源开销变大，使用了B树或者B+树（多插树）来存储可以降低很多层。少了层树就减少了IO开销。</p>
<p>B树有顺序，所以内部每一层也是用的二叉树。</p>
<p>B树有个缺点就是</p>
<ul>
<li>无法批量查找</li>
<li>查询效率不稳定</li>
<li>树高度还有下降空间</li>
</ul>
<h3 id="MySql-B-树索引"><a href="#MySql-B-树索引" class="headerlink" title="MySql B+树索引"></a>MySql B+树索引</h3><h4 id="磁盘原理"><a href="#磁盘原理" class="headerlink" title="磁盘原理"></a>磁盘原理</h4><p><img src="/Users/peterpan/Library/Application Support/typora-user-images/Screen Shot 2022-11-21 at 09.52.25.png" srcset="/img/loading.gif" lazyload alt="磁盘原理"></p>
<p>因为频繁的利用数据所以我们不一次提取4kb，而一次提取8kb，这样效率更高。</p>
<p><img src="/Users/peterpan/Library/Application Support/typora-user-images/Screen Shot 2022-11-21 at 09.53.46.png" srcset="/img/loading.gif" lazyload alt="Screen Shot 2022-11-21 at 09.53.46"></p>
<h4 id="树节点-“页”"><a href="#树节点-“页”" class="headerlink" title="树节点 = “页”"></a>树节点 = “页”</h4><p><img src="/Users/peterpan/Library/Application Support/typora-user-images/Screen Shot 2022-11-21 at 09.54.41.png" srcset="/img/loading.gif" lazyload alt="树节点为页"></p>
<p><img src="/Users/peterpan/Library/Application Support/typora-user-images/Screen Shot 2022-11-21 at 09.55.31.png" srcset="/img/loading.gif" lazyload alt="实际数据"></p>
<h4 id="B-树的由来"><a href="#B-树的由来" class="headerlink" title="B+树的由来"></a>B+树的由来</h4><p>B树有个缺点就是</p>
<ul>
<li>无法批量查找</li>
<li>查询效率不稳定</li>
<li>树高度还有下降空间</li>
</ul>
<p><strong>无法批量查找：</strong></p>
<p>叶子结点统一链接，形成单向链表。</p>
<p><strong>查询效率不稳定：</strong></p>
<p><img src="/Users/peterpan/Library/Application Support/typora-user-images/Screen Shot 2022-11-21 at 10.00.27.png" srcset="/img/loading.gif" lazyload alt="查询效率不稳定"></p>
<p>是由于每次查找结束后都会返回头节点从新开始下一次搜索，这样你搜索的节点有可能在头也可能在叶子，效率很不稳定。</p>
<p>解决办法：我们都将非叶子结点的数据都往下冗余一层，这样的话可以保证叶子结点包含所有的数据，查询都要到达底层。空间方面，我们在非叶子结点之间只存储指向下一个页的地址。</p>
<p><strong>树高度还有下降空间：</strong></p>
<p>解决办法：非叶子结点（目录结点）不再存储真实数据信息了，所以我们有了更多空间存储key和下一页地址空间，这样就变相的降低了树高。通常情况，一个16KB的”页“可以存储300～400个key和下一页地址空间的行。即使是2000w的数据，log以400为底，2000万的对数，log400（2000w）= 2.69 最多也就需要3层。  </p>
<h3 id="MySql中“聚簇索引”不是索引？"><a href="#MySql中“聚簇索引”不是索引？" class="headerlink" title="MySql中“聚簇索引”不是索引？"></a>MySql中“聚簇索引”不是索引？</h3><p>如果表里没有主键，则将表里第一个唯一索引作为主键。如果都没有那么会自动弄一个自增序列作为聚簇索引。</p>
<h2 id="MySql高频面试题"><a href="#MySql高频面试题" class="headerlink" title="MySql高频面试题"></a>MySql高频面试题</h2><h3 id="Q001-varchar字段长度有上限吗？为什么是奇怪的16383？"><a href="#Q001-varchar字段长度有上限吗？为什么是奇怪的16383？" class="headerlink" title="Q001. varchar字段长度有上限吗？为什么是奇怪的16383？"></a>Q001. varchar字段长度有上限吗？为什么是奇怪的16383？</h3><p>除了text、blob等无长度限制字段之外，其他列长度加起来不能超过64KB，即65535字节。</p>
<p>按最大4字节一个字符算65535/4 = 16383个字符。</p>
<p><strong>一个页也就16KB，一行数据就要占用4个页吗？</strong></p>
<p>每个数据行不能超过页大小16KB的一半，大概8000多字节，多出来的放在溢出页（只针对个别字段）。</p>
<p>每个页至少有两行。</p>
<p>官网规定每个表最多4096个字段（列）。</p>
<p><img src="/Users/peterpan/Library/Application Support/typora-user-images/Screen Shot 2022-11-23 at 10.26.02.png" srcset="/img/loading.gif" lazyload alt="最多4096个字段"></p>
<h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><h2 id="Redis缓存管理机制"><a href="#Redis缓存管理机制" class="headerlink" title="Redis缓存管理机制"></a>Redis缓存管理机制</h2><h3 id="淘汰策略"><a href="#淘汰策略" class="headerlink" title="淘汰策略"></a>淘汰策略</h3><p>由于缓存是有上限的，所以有了淘汰机制，最简单的淘汰机制就是定时删除。</p>
<p>惰性删除，只有在查询到的时候才删除。</p>
<p>定期删除对内存更加友好，惰性删除对 CPU 更加友好。两者各有千秋，所以 Redis 采用的是 <strong>定期删除+惰性/懒汉式删除</strong> 。 </p>
<p>避免还是无法合理的解决这个缓存的问题，我们提出了8种内存淘汰策略。避免撑满空间。</p>
<h3 id="Redis-生产问题"><a href="#Redis-生产问题" class="headerlink" title="Redis 生产问题"></a>Redis 生产问题</h3><p><strong>缓存击穿</strong>：redis中都没有缓存的key，突然请求直接大面积打到mysql，让mysql崩溃 </p>
<p>解决方案：用布隆过滤器解决。</p>
<p><strong>缓存雪崩</strong>：redis中热点key突然大面积失效，突然请求直接大面积打到mysql，让mysql崩溃。比如秒杀商品都设置固定12h，结果都失效了，还在被请求。</p>
<p>解决方案：随机设置热点key的过期时间，让它们不一致；设置永久不过期，比如双11期间这些热点商品keyID都不过期。</p>
<h2 id="Redis持久化存储机制"><a href="#Redis持久化存储机制" class="headerlink" title="Redis持久化存储机制"></a>Redis持久化存储机制</h2><h3 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h3><p><strong>什么是 AOF 持久化？</strong></p>
<p>与快照持久化相比，AOF 持久化的实时性更好，因此已成为主流的持久化方案。默认情况下 Redis 没有开启 AOF（append only file）方式的持久化，可以通过 appendonly 参数开启：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs bash">appendonly <span class="hljs-built_in">yes</span><br></code></pre></td></tr></table></figure>
<p>开启 AOF 持久化后每执行一条会更改 Redis 中的数据的命令，Redis 就会将该命令写入到内存缓存 <code>server.aof_buf</code> 中，然后再根据 <code>appendfsync</code> 配置来决定何时将其同步到硬盘中的 AOF 文件。（AOF很像是binlog）</p>
<p>AOF 文件的保存位置和 RDB 文件的位置相同，都是通过 dir 参数设置的，默认的文件名是 <code>appendonly.aof</code>。</p>
<p>在 Redis 的配置文件中存在三种不同的 AOF 持久化方式，它们分别是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">appendfsync always    <span class="hljs-comment">#每次有数据修改发生时都会写入AOF文件,这样会严重降低Redis的速度</span><br>appendfsync everysec  <span class="hljs-comment">#每秒钟同步一次，显式地将多个写命令同步到硬盘</span><br>appendfsync no        <span class="hljs-comment">#让操作系统决定何时进行同步</span><br></code></pre></td></tr></table></figure>
<p>为了兼顾数据和写入性能，用户可以考虑 <code>appendfsync everysec</code> 选项 ，让 Redis 每秒同步一次 AOF 文件，Redis 性能几乎没受到任何影响。而且这样即使出现系统崩溃，用户最多只会丢失一秒之内产生的数据。当硬盘忙于执行写入操作的时候，Redis 还会优雅的放慢自己的速度以便适应硬盘的最大写入速度。</p>
<p><strong>AOF日志如何实现？</strong></p>
<p>关系型数据库（如MySQL）通常都是<strong>执行命令之前</strong>记录日志（方便故障恢复），而 Redis AOF 持久化机制是在<strong>执行完命令之后</strong>再记录日志。（对比binlog和undo log 说的）</p>
<p><strong>AOF重写</strong></p>
<p>重写开始的时候记录一个快照，最后整理完的对比现在aof_buf里面的，多出来的直接添加到重写过的aof的后面。</p>
<p><img src="/Users/peterpan/Library/Application Support/typora-user-images/Screen Shot 2022-11-19 at 16.05.43.png" srcset="/img/loading.gif" lazyload alt="AOF重写"></p>
<h3 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h3><p>压缩二进制的备份，然后可以自定义备份的周期时间。</p>
<p>Redis 提供了两个命令来生成 RDB 快照文件：</p>
<ul>
<li><code>save</code> : 主线程执行，会阻塞主线程；</li>
<li><code>bgsave</code> : 子线程执行，不会阻塞主线程，默认选项。</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><strong>RDB 比 AOF 优秀的地方</strong> ：</p>
<ul>
<li>RDB 文件存储的内容是经过压缩的二进制数据， 保存着某个时间点的数据集，文件很小，适合做数据的备份，灾难恢复（RDB更像是redo log，记录的是压缩后的二进制的真实数据）。AOF 文件存储的是每一次写命令，类似于 MySQL 的 binlog 日志，通常会必 RDB 文件大很多。当 AOF 变得太大时，Redis 能够在后台自动重写 AOF。新的 AOF 文件和原有的 AOF 文件所保存的数据库状态一样，但体积更小。不过， Redis 7.0 版本之前，如果在重写期间有写入命令，AOF 可能会使用大量内存，重写期间到达的所有写入命令都会写入磁盘两次。</li>
<li>使用 RDB 文件恢复数据，直接解析还原数据即可，不需要一条一条地执行命令，速度非常快。而 AOF 则需要依次执行每个写命令，速度非常慢。也就是说，与 AOF 相比，恢复大数据集的时候，RDB 速度更快。</li>
</ul>
<p>（1、RDB是经过二进制压缩的，只保存时间戳+数据集，文件小，适合做备份和灾难恢复；2、直接还原数据就行，而AOF需要逐条指令写入）</p>
<p><strong>AOF 比 RDB 优秀的地方</strong> ：</p>
<ul>
<li>RDB 的数据安全性不如 AOF，没有办法实时或者秒级持久化数据。生成 RDB 文件的过程是比繁重的， 虽然 BGSAVE 子进程写入 RDB 文件的工作不会阻塞主线程，但会对机器的 CPU 资源和内存资源产生影响，严重的情况下甚至会直接把 Redis 服务干宕机。AOF 支持秒级数据丢失（取决 fsync 策略，如果是 everysec，最多丢失 1 秒的数据），仅仅是追加命令到 AOF 文件，操作轻量。</li>
<li>RDB 文件是以特定的二进制格式保存的，并且在 Redis 版本演进中有多个版本的 RDB，所以存在老版本的 Redis 服务不兼容新版本的 RDB 格式的问题。</li>
<li>AOF 以一种易于理解和解析的格式包含所有操作的日志。你可以轻松地导出 AOF 文件进行分析，你也可以直接操作 AOF 文件来解决一些问题。比如，如果执行<code>FLUSHALL</code>命令意外地刷新了所有内容后，只要 AOF 文件没有被重写，删除最新命令并重启即可恢复之前的状态。</li>
</ul>
<p>（1、RDB记录的是数据，虽然恢复容易，但是记录的时候很占用cpu和内存的资源，比如AOF的秒级持久化安全；2、RDB是特定的二进制格式保存的，所以序列化的方式可能不同，有多个版本的RDB，存在老版本的Redis服务不兼容新版本的RDB格式的问题；3、AOF的分析很直观，都是语句）</p>
<h2 id="Redis的高可用和哨兵机制"><a href="#Redis的高可用和哨兵机制" class="headerlink" title="Redis的高可用和哨兵机制"></a>Redis的高可用和哨兵机制</h2><p>通过主从模式，主节点负责写数据，从节点要负责度数据，然后做好数据同步，读写分离提高性能。另外主节点崩溃了，从节点就顶上去，还可以实现高可用。</p>
<p><img src="/Users/peterpan/Library/Application Support/typora-user-images/image-20221119162231298.png" srcset="/img/loading.gif" lazyload alt="image-20221119162231298"></p>
<p><strong>Sentinel有什么作用？</strong></p>
<ul>
<li>监控：监控所有redis的（包括自己）状态是否正常。</li>
<li>故障转移：如果一个master出现故障，Sentinel会帮助我们实现故障转移，自动将某一台slave升级为master，确保整个Redis系统的可用性。</li>
<li>通知：通知slave新的master连接信息，让他们执行replicaof成为新的matser的slave。</li>
<li>配置提供：客户端链接sentinel请求master的地址，如果发生故障转移，sentinel会通知新的master连接信息给客户端。</li>
</ul>
<p>Redis Sentinel  本身设计的就是一个分布式系统，建议多个sentinel节点协作运行。这样做的好处是：</p>
<ul>
<li>多个sentinel节点通过投票的方式来确定sentinel节点是否真的不可用，避免误判（比如网络问题可能会导致误判）</li>
<li>Sentinel自身就是高可用</li>
</ul>
<p>如果想要实现高可用，建议将哨兵 Sentinel 配置成单数且大于等于 3 台。高可用是系统不间断的运行的能力。</p>
<p><strong>Sentinel如何检测节点是否下线？</strong></p>
<ul>
<li>主观下线：哨兵节点认为某个Redis节点已经下线了，但还不是很确定，<strong>需要其他sentinel节点的投票</strong>。</li>
<li>客观下线：法定数量过半认为某个redis节点下线了，那就是真的下线了，<strong>被动下线</strong>。</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/738439/1663979614062-f3219a07-0815-4b0d-9b63-750219d9e59c.png" srcset="/img/loading.gif" lazyload alt="redis-master-slave-sentinel-ping.png"></p>
<p>有效回复不一定是PONG，可以是-LOADING或者-MASTERDOWN。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/738439/1663979628031-1ccb8eb9-5da0-46d5-a16a-01f6724c2ee1.png" srcset="/img/loading.gif" lazyload alt="redis-master-slave-sentinel-ping-sdown.png"></p>
<p><strong>slave下线对redis集群影响不大，但是master认定主观下线就不一样了</strong>，sentinel整体还要对其进行进一步核实，确保master是真的下线了。</p>
<p>master 才被判定客观下线。当法定数量（通常为过半）的sentinel节点认定master已经下线，裁判定下线。这样做的目的是为了<strong>防止误判</strong>，毕竟故障转移的开销比较大，这也是为什么Redis官方推荐部署多个sentinel节点。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/738439/1663979639394-8eb65a8f-5905-473d-90d8-47cba7c58ae5.png" srcset="/img/loading.gif" lazyload alt="redis-master-slave-sentinel-ping-odown.png"></p>
<p>哨兵中会有一个Leader的角色来负责故障转移，自动从slave中选出一个新的master并执行完相关的一些工作（比如通知slave新的master连接信息，让它们执行replicaof成为新的master的slave）。</p>
<p>如果没有足够数量的sentinel节点认定master已经下线的话，当master能对sentinel的PING命令进行有效回复之后，master也就不再被认定为主观下线，回归正常。</p>
<p>高可用的根本就是要求我们总有个redis在工作，不会挂掉。单纯的集群并不能够有高可用，因为集群无法保证其本身高可用，若你坏掉一个master，里面的缓存就全部丢了，其实还是资源浪费还是很大的，很可能出现缓存击穿，甚至是雪崩。所以我们需要集群和高可用哨兵共同解决高可用和负载均衡的问题。</p>
<h2 id="Redis的集群"><a href="#Redis的集群" class="headerlink" title="Redis的集群"></a>Redis的集群</h2><p>集群就是多个master</p>
<p>1、缓存的数据量太大，不够放的。</p>
<p>2、并发量要求太大。</p>
<p>核心思想就是分摊压力，同样的效能给两个能干活的人一定是压力减半的。</p>
<p><img src="https://www.yuque.com/api/filetransfer/images?url=https%3A%2F%2Fguide-blog-images.oss-cn-shenzhen.aliyuncs.com%2Fgithub%2Fjavaguide%2Fdatabase%2Fredis%2Fredis-cluster%2Fredis-cluster-shard.png&amp;sign=33a67ec08ad62aa857bafa46a651b091322094cb5ebd49722d3e45d87d76a619" srcset="/img/loading.gif" lazyload alt="img"></p>
<h1 id="CAP理论"><a href="#CAP理论" class="headerlink" title="CAP理论"></a>CAP理论</h1><h2 id="CAP基础"><a href="#CAP基础" class="headerlink" title="CAP基础"></a>CAP基础</h2><p><strong>一致性（Consistency）</strong>：等同于所有结点访问<strong>同一份</strong>【最新】的数据副本</p>
<p><strong>可用性（Availability）</strong>：每次请求都能获取到<strong>非错</strong>的响应——但<strong>不能</strong>保证获取的数据为最新数据</p>
<p><strong>分区容错性（Partition Tolerance）</strong>：以实际效果而言，分区相当于对通信的时限要求。系统如果不能在时限内达成数据一致性，就意味着发生了分区的情况，必须就当前操作在C和A之间做出选择。（简单解释：分区容忍性就是尽管任意数量的消息被节点间的网络<strong>丢失或延迟</strong>，系统仍然正常运行。</p>
<p>对于一个分布式系统不可能同时满足以上三点。</p>
<p><img src="https://raw.githubusercontent.com/csunny/etcd-from-arch-to-souce-code/master/_asserts/images/cap.jpg" srcset="/img/loading.gif" lazyload alt="CAP理论- ETCD源码剖析"></p>
<p><strong>Q1:CAP的C和事务中的ACID的C一样吗？</strong></p>
<p>A：不一样，因为CAP的C强调的是所有的分布式结点访问的都是<strong>最新</strong>的<strong>同一份</strong>数据。而事务中的ACID的C指的是事务前后的状态是一致的，比如说A转账给B，转移前后他俩的金钱总额不会改变。</p>
<p><strong>一写（A可用性得到了保证）</strong></p>
<p><img src="/Users/peterpan/Library/Application Support/typora-user-images/Screen Shot 2022-11-20 at 10.34.25.png" srcset="/img/loading.gif" lazyload alt="一写"></p>
<p><strong>三写（C一致性得到了保证）</strong></p>
<p><img src="/Users/peterpan/Library/Application Support/typora-user-images/Screen Shot 2022-11-20 at 10.34.51.png" srcset="/img/loading.gif" lazyload alt="三写"></p>
<h2 id="CAP的现实用例"><a href="#CAP的现实用例" class="headerlink" title="CAP的现实用例"></a>CAP的现实用例</h2><p><strong>在分布式环境下，P一定是存在的，一旦出现了网络分区，那么一致性和可用性就一定要抛弃一个。</strong></p>
<p>对于NoSql数据库，更加注重可用性，比如redis，所以这是一个AP系统。</p>
<p>对于分布式关系行数据库，必须要保证一致性，比如mysql，所以这是一个CP系统。</p>
<p>但分布式关系型数据库仍有高可用性需求，虽然达不到CAP理论中的100%可用性，但一般都具备五个9（99.999%）以上的高可用。</p>
<p>我们可以把分布式关系型数据库看作<strong>CP+HA</strong>的系统（CP就是一致性数据库，HA就是高可用性集群，如哨兵机制实现的主从关系）。由此产生了两个广泛应用的指标。</p>
<p><strong>RPO（Recovery Point Objective）</strong>：恢复点目标，指数据库在灾难发生后会丢失多长时间的数据。分布式关系型数据库RPO=0。</p>
<p><strong>RTO（Recovery Time Objective）</strong>：恢复时间目标，指数据库在灾难发生后到整个系统恢复正常所需要的时间。分布式关系行数据库RTO&lt;几分钟。</p>
<h2 id="CAP视角看较成熟的分布式方案"><a href="#CAP视角看较成熟的分布式方案" class="headerlink" title="CAP视角看较成熟的分布式方案"></a>CAP视角看较成熟的分布式方案</h2><p><strong>Quorum Replication</strong> </p>
<p>详解 <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/232351178">https://zhuanlan.zhihu.com/p/232351178</a></p>
<ul>
<li>N（副本数），W（写入成功副本数），R（读取成功副本数）</li>
<li>W + R &gt; N，永远都有一个副本是最新且正确的，即最少的情况是 W + R = N + 1，这个1就是至少多出来的，如果说没有重合的地方，那么他们就不会大于N。</li>
<li>N = 3， W = 1， R = 3（写可用AP，读一致CP）</li>
<li>N = 3， W = 3， R = 1（写一致CP，读可用AP）</li>
</ul>
<p><strong>共识算法</strong></p>
<ul>
<li><p>副本之间有交互，leader提供读写，leader宕了选一个新leader，只有选举的短暂过程不可用</p>
</li>
<li><p>CP + HA</p>
</li>
</ul>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/Back-End-Engineer/">Back-End Engineer</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Back-End-Engineer/">Back-End Engineer</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/11/22/community-project/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">community-project</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/11/11/%E5%B0%8F%E8%AF%B4%E6%B8%B8%E5%9B%AD%E4%BC%9A%E9%A1%B9%E7%9B%AE/">
                        <span class="hidden-mobile">小说游园会 study</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> & <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  










  

  
    <!-- MathJax -->
    <script>
      MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
        },
        loader: {
          load: ['ui/lazy']
        },
        options: {
          renderActions: {
            findScript: [10, doc => {
              document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
                const display = !!node.type.match(/; *mode=display/);
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                const text = document.createTextNode('');
                node.parentNode.replaceChild(text, node);
                math.start = { node: text, delim: '', n: 0 };
                math.end = { node: text, delim: '', n: 0 };
                doc.math.push(math);
              });
            }, '', false],
            insertedScript: [200, () => {
              document.querySelectorAll('mjx-container').forEach(node => {
                let target = node.parentNode;
                if (target.nodeName.toLowerCase() === 'li') {
                  target.parentNode.classList.add('has-jax');
                }
              });
            }, '', false]
          }
        }
      };
    </script>

    <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" ></script>

  











<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
